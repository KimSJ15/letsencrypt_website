---
title: Виды проверок
slug: challenge-types
top_graphic: 1
date: 2019-02-25
lastmod: 2019-02-25
---

Когда вы запрашиваете новый сертификат у Let’s Encrypt, наши серверы проверяют 
ваши права на доменные имена в сертификате, используя так называемые "испытания" 
(или "проверки", согласно стандарта ACME. Обычно проверки выполняются с помощью
вашего ACME-клиента и не требуют дополнительной настройки, но для сложных конфигураций
будет полезным узнать о проверках чуть больше. Если вы не уверены, какую именно проверку
применять - используйте настройки по-умолчанию для вашего ACME-клиента, 
или проверку HTTP-01.

# Проверка HTTP-01

Этот тип проверки используется чаще всего. Let’s Encrypt выдаёт ACME-клиенту токен,
а ACME-клиент записывает этот токен в файл на вашем web-сервере по пути
`http://<YOUR_DOMAIN>/.well-known/acme-challenge/<TOKEN>`. В этом файле содержится 
сам токен, плюс отпечаток ключа вашего аккаунта. Как только ACME-клиент сообщит
Let’s Encrypt, что файл готов, Let’s Encrypt будет пытаться получить этот файл 
по URL (возможно, несколько раз, с с различных адресов). Если полученный ответ будет
верным, проверка считается успешной, и сертификат можно использовать для выбранного домена.
Если проверка прошла неудачно, требуется повторить попытку с новым сертификатом. 

Наша реализация проверки HTTP-01 разрешает редиректы запросов, общим числом не более 10. 
Редиректы принимаются только на адреса, начинающиеся с “http:” или “https:”, 
и только на порты 80 или 443. Редиректы на IP-адреса не принимаются. Если редирект был на 
URL c HTTPS, то сертификат не считается подтверждённым (т.к. проверка предназначена новых валидных
сертификатов, в ходе проверки могут обнаружиться самоподписанные или просроченные сертификаты).

Проверка HTTP-01 может быть выполнена только с использованием порта 80. Произвольный порт
для проверки может снизить её надёжность, и потому запрещён стандартом ACME.

Плюсы:

 - Упрощённая автоматизация процесса, не требующая дополнительных знаний по настройке доменов
 - Позволяет хостинг-провайдерам выпускать сертификаты для доменов, принадлежащих им по CNAME.
 - Совместим с уже настроенными web-серверами.
 
 Минусы:
 
 - Требует открытого порта 80 (редко, но интернет-провайдеры блокируют этот адрес)
 - Let’s Encrypt не позволяет использовать эту проверку для сертификатов с возможностью
 подстановки (wildcard-сертификатов).
 - Если у вас несколько web-серверов, файл требуется создавать для каждого из них.

# Проверка DNS-01

Эта проверка требует подтверждения прав на домен с помощью специальной TXT-записи для 
доменного имени. Это сложнее в настройке, чем для проверки HTTP-01, но покрывает 
сценарии использования, недоступные для проверки HTTP-01. Кроме того, проверка DNS-01
позволяет выпускать сертификаты с подстановкой (wildcard-сертификаты). 
После того, как Let’s Encrypt вашему ACME-клиенту токен, клиент создаёт содержимое TXT-записи,
производную от токена и ключа аккаунта, и записывает её в `_acme-challenge.<YOUR_DOMAIN>`.
Далее, Let’s Encrypt запрашивает TXT-запись в DNS-зоне вашего домена. Если значения совпадают - 
сертификат можно использовать!

Крайне важно автоматизировать процессы выпуска и отзыва сертификатов, поэтому проверку DNS-01
имеет смысл использовать, когда ваш DNS-провайдер предоставляет API для автоматических
обновлений. Наше сообщество поддерживает [список таких DNS-провайдеров][dns-api-providers].
Ваш DNS-провайдер может быть либо вашим регистратором доменов (компанией, у которой вы купили
доменное имя), либо сторонней организацией. Если вы захотите сменить DNS-провайдера, нужно
будет будет сделать незначительные изменения у регистратора доменов. Ожидать окончания срока
действия сертификатов при этом не требуется.

Обратите внимание, что размещение полноправной учётной записи для DNS API на web-сервере существеннно
увеличивает возможный ущерб при взломе. Лучше всего использовать 
[учётную запись с ограниченными возможностями][securing-dns-credentials], или выполнять 
проверку DNS-01 на отдельном сервере, с последующим копированием сертификатов на web-сервер.

Т.к. Let’s Encrypt придерживается стандартов DNS для поиска TXT-записи при проверке DNS-01, 
вы можете задействовать записи CNAME или NS для делегирования права ответа за другие DNS-зоны. 
Например [настроив субдомен `_acme-challenge`][securing-dns-credentials] для специального 
сервера валидации. Или, если ваш DNS-провайдер медленно обновляет данные, и вы хотите использовать
более быстрый сервер.

У большинства DNS-провайдеров есть так называемый "период обновления данных", показывающий,
сколько времени пройдёт с момента изменения DNS-записи до её обновления на всех серверах 
провайдера. Этот период достаточно сложно оценить, т.к. зачастую DNS-провайдеры применяют 
[anycast] - когда несколько серверов имеют один и тот же IP-адрес. В этом случае, в зависимости
от вашей геолокации, вы и Let’s Encrypt можете взаимодействовать с разными серверами, 
и получать разные результаты. Лучшие DNS API содержат методы автоматического уведомления о полном
обновлении данных на всех серверах провайдера. Если ваш DNS-провайдер такой информации не даёт, 
вам придётся настроить ACME-клиент на достаточно долгое (не менее часа) ожидание перед запуском 
валидации.

Для одного и того же доменного имени может быть несколько TXT-записей. Например, когда требуется
одновременно выполнить проверку и для обычного сертификата, и для wildcard-сертификата. Своевременно
удаляйте неактуальные TXT-записи, т.к. из-за большого размера ответа от сервера при проверке   
Let’s Encrypt может признать проверку неудачной.

Плюсы:

 - Эту проверку можно использовать для сертификатов с возможностью подстановки (wildcard-сертификатов).
 - Одна запись для нескольких web-серверов.
 
Минусы:

 - Хранение учётной записи для DNS API имеет свои риски.
 - Ваш DNS-провайдер можеит не иметь своего API
 - DNS API может не иметь возможности оценить период обновления данных.
 
# TLS-SNI-01

Эта проверка была описана в черновых версиях протокола ACME. 
Согласно ей вначале выполняется TLS handshake на порте 443, и посылается
специальный [SNI] заголовок для поиска сертификата, содержашего токен.
Проверка TLS-SNI-01 [была отключена в марте 2019][tls-sni-disablement]
по причине недостаточной безопасности.

# TLS-ALPN-01

Проверка была разработана после признания проверки TLS-SNI-01 устаревшей, 
как [отдельный стандарт][tls-alpn]. Как и TLS-SNI-01, проверка TLS-ALPN-01
выполняется через TLS handshake на порте 443. Но в данном случае применяется
специальный протокол ALPN, чтобы на запросы валидации отвечали только серверы,
знающие про такой тип проверки. Кроме того, становится возможным использовать 
SNI-поле, совпадающее с именем домена, для которого проводится валидация,
для увеличения надёжности проверки.

Эта проверка не подходит для массового использования. Она, скорее, предназначена
для владельцев TLS-концевых обратных прокси-серверов, для выполнения проверки 
типа HTTP-01, но внутри слоя TLS, для разделения ответственности. Как правило,
это относится к большим хостинг-провайдерам, но распространённые web-серверы типа
Apache и Nginx, однажды, поддержат протокол ALPN (а [Caddy уже поддерживает][caddy-tls-alpn]).

Плюсы:

 - Будет работать даже если порт 80 закрыт.
 - Может быть реализована целиком внутри слоя TLS
 
Минусы:

 - Пока не поддерживается Apache, Nginx или Certbot, и, возможно, не будет поддерживаться.
 - Как и для проверки HTTP-01, настраивать нужно ответ от каждого web-сервера.

[dns-api-providers]: https://community.letsencrypt.org/t/dns-providers-who-easily-integrate-with-lets-encrypt-dns-validation/86438
[securing-dns-credentials]: https://www.eff.org/deeplinks/2018/02/technical-deep-dive-securing-automation-acme-dns-challenge-validation
[anycast]: https://en.wikipedia.org/wiki/Anycast
[SNI]: https://en.wikipedia.org/wiki/Server_Name_Indication
[tls-sni-disablement]: https://community.letsencrypt.org/t/march-13-2019-end-of-life-for-all-tls-sni-01-validation-support/74209
[tls-alpn]: https://tools.ietf.org/html/draft-ietf-acme-tls-alpn-01
[caddy-tls-alpn]: https://caddy.community/t/caddy-supports-the-acme-tls-alpn-challenge/4860
